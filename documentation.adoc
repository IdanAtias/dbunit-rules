:toc: center
:backend: pdf
:doctitle: Living Documentation
:doctype: book
:icons: font
:numbered:
:!linkcss:
:sectanchors:
:sectlink:
:docinfo:
:source-highlighter: highlightjs
:toclevels: 3
:revnumber: 0.13.3-SNAPSHOT
:hardbreaks:

= *Living Documentation*

include::/home/travis/build/rmpestano/dbunit-rules/core/target/test-classes/cukedoctor-intro.adoc[leveloffset=+1]

== *Summary*
[cols="12*^m", options="header,footer"]
|===
3+|Scenarios 7+|Steps 2+|Features: 6

|[green]#*Passed*#
|[red]#*Failed*#
|Total
|[green]#*Passed*#
|[red]#*Failed*#
|[purple]#*Skipped*#
|[maroon]#*Pending*#
|[yellow]#*Undefined*#
|[blue]#*Missing*#
|Total
|Duration
|Status

12+^|*<<Manage-database-with-DBUnit-Rules-Core>>*
|1
|0
|1
|4
|0
|0
|0
|0
|0
|4
|000ms
|[green]#*passed*#

12+^|*<<Manage-database-with-DBUnit-Rules-CDI>>*
|1
|0
|1
|4
|0
|0
|0
|0
|0
|4
|617ms
|[green]#*passed*#

12+^|*<<Manage-database-with-DBUnit-Rules-Cucumber>>*
|1
|0
|1
|5
|0
|0
|0
|0
|0
|5
|000ms
|[green]#*passed*#

12+^|*<<Manage-database-with-DBUnit-Rules-and-JUnit-5>>*
|1
|0
|1
|3
|0
|0
|0
|0
|0
|3
|000ms
|[green]#*passed*#

12+^|*<<Dynamic-data-using-scritable-datasets>>*
|2
|0
|2
|7
|0
|0
|0
|0
|0
|7
|000ms
|[green]#*passed*#

12+^|*<<Database-assertion-using-expected-datasets>>*
|5
|0
|5
|16
|0
|0
|0
|0
|0
|16
|001ms
|[green]#*passed*#
12+^|*Totals*
|11|0|11|39|0|0|0|0|0|39 2+|620ms
|===

== *Features*

[[Manage-database-with-DBUnit-Rules-Core, Manage database with DBUnit Rules Core]]
=== *Manage database with DBUnit Rules Core*

****
====
[quote]
____
In order to manage database state in JUnit tests
As a developer
I want to use DBUnit in my tests.
____
====

DBUnit Rules Core module brings http://dbunit.sourceforge.net/[DBunit^] to your unit tests via https://github.com/junit-team/junit4/wiki/Rules[JUnit rules^].

[discrete]
=== *Dependencies*

To use it just add the following maven dependency:

[source,xml,indent=0]
----
<dependency>
   <groupId>com.github.dbunit-rules</groupId>
   <artifactId>core</artifactId>
include::../../../pom.xml[tags=version]
   <scope>test</scope>
</dependency>
----
****

==== Scenario: Seed database using yml dataset

****
Given ::
=====
The following junit rules icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java]
----
@RunWith(JUnit4.class)
public class DBUnitRulesIt {
include::../../src/test/java/com/github/dbunit/rules/DBUnitRulesIt.java[tags=rules]
}
----
[discrete]
<1> https://github.com/rmpestano/dbunit-rules/blob/master/jpa/src/main/java/com/github/dbunit/rules/jpa/EntityManagerProvider.java[EntityManagerProvider^] is a simple Junit rule that creates a JPA entityManager for each test. DBUnit rule don’t depend on EntityManagerProvider, it only needs a JDBC connection.
[discrete]
<2> DBUnit rule responsible for reading `@DataSet` annotation and prepare the database for each test.


******

=====
And ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.src/test/resources/dataset/yml/users.yml
----
include::../../src/test/resources/datasets/yml/users.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java]
----
include::../../src/test/java/com/github/dbunit/rules/DBUnitRulesIt.java[tags=seedDatabase]
----


******

TIP: Source code of the above example can be https://github.com/rmpestano/dbunit-rules/blob/master/core/src/test/java/com/github/dbunit/rules/DBUnitRulesIt.java/#L31[found here^].

=====
Then ::
=====
The database should be seeded with the dataset content before test execution icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

[[Manage-database-with-DBUnit-Rules-CDI, Manage database with DBUnit Rules CDI]]
=== *Manage database with DBUnit Rules CDI*

****
====
[quote]
____
In order to manage database state in *CDI* based tests
As a developer
I want to use DBUnit in a CDI test environment.
____
====

DBUnit CDI integration is done through a https://docs.jboss.org/weld/reference/latest/en-US/html_single/#interceptors[CDI interceptor^] which reads `@DataSet` to prepare database for CDI based tests.

[IMPORTANT]
=====
CDI must be enabled in your test, see the following example:

[source, java]
----
@RunWith(CdiTestRunner.class) <1>
@DBUnitInterceptor <2>
public class DBUnitCDITest {

}
----
<1> https://deltaspike.apache.org/documentation/test-control.html[CdiTestRunner^] is provided by https://deltaspike.apache.org[Apache Deltaspike^] but you should be able to use other CDI test runners.
<2> Needed to activate DBUnit interceptor
=====

[discrete]
=== *Dependencies*

To use this module just add the following maven dependency:

[source,xml,indent=0]
----
<dependency>
   <groupId>com.github.dbunit-rules</groupId>
   <artifactId>cdi</artifactId>
include::../../../pom.xml[tags=version]
   <scope>test</scope>
</dependency>
----
****

==== Scenario: Seed database using yml dataset

****
Given ::
=====
DBUnit interceptor is enabled in your test beans.xml: icon:thumbs-up[role="green",title="Passed"] [small right]#(617ms)#
******

[discrete]
.src/test/resources/META-INF/beans.xml
[discrete]
[source,xml]
----
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://java.sun.com/xml/ns/javaee"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/beans_1_0.xsd">
     <interceptors>
            <class>com.github.dbunit.rules.cdi.DBUnitInterceptorImpl</class>
     </interceptors>
</beans>
----


******

[IMPORTANT]
======

Your test itself must be a CDI bean to be intercepted. if you’re using https://deltaspike.apache.org/documentation/test-control.html[Deltaspike test control^] just enable the following property in `test/resources/META-INF/apache-deltaspike.properties`:
----

deltaspike.testcontrol.use_test_class_as_cdi_bean=true
----
======

=====
And ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.src/test/resources/dataset/yml/users.yml
----
include::../../../cdi/src/test/resources/datasets/yml/users.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java]
----
include::../../../cdi/src/test/java/com/github/dbunit/rules/cdi/DBUnitCDIIt.java[tags=seedDatabase]
----


******

TIP: Source code of the above example can be https://github.com/rmpestano/dbunit-rules/blob/master/cdi/src/test/java/com/github/dbunit/rules/cdi/DBUnitCDIIt.java#L74[found here^].

=====
Then ::
=====
The database should be seeded with the dataset content before test execution icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

[[Manage-database-with-DBUnit-Rules-Cucumber, Manage database with DBUnit Rules Cucumber]]
=== *Manage database with DBUnit Rules Cucumber*

****
====
[quote]
____
In order to manage database state in `BDD` tests
As a BDD developer
I want to use DBUnit along side my BDD tests.
____
====

DBUnit enters the BDD world through a dedicated JUNit runner which is based on https://cucumber.io/[Cucumber^] and https://deltaspike.apache.org/[Apache DeltaSpike^].

This runner just starts CDI within your BDD tests so you just have to use <<Manage database with DBUnit Rules CDI,DBUnit rules CDI interceptor>> on Cucumber steps, here is the so called Cucumber CDI runner declaration:

[source,java]
----
include::../../src/test/java/com/github/dbunit/rules/bdd/DBUnitRulesBdd.java[]
----


IMPORTANT: As cucumber doesn't work with JUnit Rules, see https://github.com/cucumber/cucumber-jvm/issues/393[this issue^], you won't be able to use Cucumber runner with _DBunit Rules Core_ because its based on JUnit rules, but you can use DataSetExecutor in `@Before`, see https://github.com/rmpestano/dbunit-rules/tree/master/examples/jpa-productivity-boosters/src/test/java/com/github/dbunit/rules/examples/cucumber/withoutcdi[example here^].

[discrete]
=== *Dependencies*
Here is a set of maven dependencies needed by DBUnit rules Cucumber:

NOTE: Most of the dependencies, except CDI container implementation, are bring by DBUnit Rules Cucumber module transitively.

[source,xml,indent=0]
----
<dependency>
   <groupId>com.github.dbunit-rules</groupId>
   <artifactId>cucumber</artifactId>
include::../../../pom.xml[tags=version]
   <scope>test</scope>
</dependency>
----

.Cucumber dependencies
[source,xml,indent=0]
----
include::../../../cucumber/pom.xml[tags=cucumber-deps]
----
<1> You don't need to declare because it comes with DBUnit Rules Cucumber module dependency.

.DeltaSpike and CDI dependency
[source,xml,indent=0]
----
include::../../../cucumber/pom.xml[tags=deltaspike-cdi-deps]
----
<2> Also comes with DBUit Rules Cucumber.
<3> You can use CDI implementation of your choice.


To use this module just add the following maven dependency:


=====
****

==== Scenario: Seed database using DBUnit rules in Cucumber tests

****
Given ::
=====
The following feature icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

----
include::../../../examples/jpa-productivity-boosters/src/test/resources/features/contacts.feature[]
----


******

=====
And ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

----
include::../../../examples/jpa-productivity-boosters/src/test/resources/datasets/contacts.yml[]
----


******

=====
And ::
=====
The following Cucumber test icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,linenums]
----
include::../../../examples/jpa-productivity-boosters/src/test/java/com/github/dbunit/rules/examples/cucumber/ContactFeature.java[]
----


******

=====
When ::
=====
The following cucumber steps are executed icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,linenums]
----
include::../../../examples/jpa-productivity-boosters/src/test/java/com/github/dbunit/rules/examples/cucumber/ContactSteps.java[]
----
[discrete]
<1> As the Cucumber cdi runner enables CDI, you can use injection into your Cucumber steps.
[discrete]
<2> Here we use the DBUnit Rules CDI interceptor to seed the database before step execution.


******

TIP: Source code for the example above can be https://github.com/rmpestano/dbunit-rules/blob/master/examples/jpa-productivity-boosters/src/test/java/com/github/dbunit/rules/examples/cucumber/ContactSteps.java#L16[found here^].

=====
Then ::
=====
The database should be seeded with the dataset content before step execution icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

[[Manage-database-with-DBUnit-Rules-and-JUnit-5, Manage database with DBUnit Rules and JUnit 5]]
=== *Manage database with DBUnit Rules and JUnit 5*

****
====
[quote]
____
In order to manage database state in http://junit.org/junit5/[JUnit 5^] integration tests
As a developer
I want to use DBUnit along side my JUnit 5 tests.
____
====

DBUnit is enabled in JUnit 5 tests through an http://junit.org/junit5/docs/current/user-guide/#extensions[extension^] named *DBUnitExtension*.

[discrete]
=== *Dependencies*

To use the extension just add the following maven dependency:

[source,xml,indent=0]
----
<dependency>
   <groupId>com.github.dbunit-rules</groupId>
   <artifactId>junit5</artifactId>
include::../../../pom.xml[tags=version]
   <scope>test</scope>
</dependency>
----
****

==== Scenario: Seed database using DBUnit rules in JUnit5 tests

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.src/test/resources/dataset/users.yml
----
include::../../../junit5/src/test/resources/datasets/users.yml[]
----


******

=====
When ::
=====
The following junit5 test is executed icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,linenums]
----
include::../../../junit5/src/test/java/com/github/dbunit/rules/junit5/DBUnitJUnit5It.java[tags=declaration;connectionField;test]
----
[discrete]
<1> Enables DBUnit;
[discrete]
<2> JUnit 5 runner;
[discrete]
<3> As JUnit5 requires *Java8* you can use lambdas in your tests;
[discrete]
<4> DBUnitExtension will get connection by reflection so just declare a field or a method with `ConnectionHolder` as return type.


******

TIP: Source code of the above example can be https://github.com/rmpestano/dbunit-rules/blob/master/junit5/src/test/java/com/github/dbunit/junit5/DBUnitJUnit5It.java/#L22[found here^].

=====
Then ::
=====
The database should be seeded with the dataset content before test execution icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

[[Dynamic-data-using-scritable-datasets, Dynamic data using scritable datasets]]
=== *Dynamic data using scritable datasets*

****
====
[quote]
____
In order to have dynamic data in datasets
As a developer
I want to use scripts in DBUnit datasets.
____
====

Scritable datasets are backed by JSR 223.footnote:[Scripting for the Java Platform, for more information access the official https://docs.oracle.com/javase/8/docs/technotes/guides/scripting/prog_guide/api.html[docs here^]].
****

==== Scenario: Seed database with groovy script in dataset

****
Given ::
=====
Groovy script engine is on test classpath icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

----
<dependency>
    <groupId>org.codehaus.groovy</groupId>
    <artifactId>groovy-all</artifactId>
    <version>2.4.6</version>
    <scope>test</scope>
</dependency>
----


******

=====
And ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

----
include::../../../core/src/test/resources/datasets/yml/groovy-with-date-replacements.yml[]
----
[discrete]
<1> Groovy scripting is enabled by `groovy:` string.


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,indent=0,linenums]
----
include::../../../core/src/test/java/com/github/dbunit/rules/ScriptReplacementsIt.java[tags=groovy]
----


******

=====
Then ::
=====
Dataset script should be interpreted while seeding the database icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

==== Scenario: Seed database with javascript in dataset

NOTE: Javascript engine comes within JDK so no additional classpath dependency is necessary.

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

----
include::../../../core/src/test/resources/datasets/yml/js-with-calc-replacements.yml[]
----
[discrete]
<1> Javascript scripting is enabled by `js:` string.


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,linenums,indent=0]
----
include::../../../core/src/test/java/com/github/dbunit/rules/ScriptReplacementsIt.java[tags=javascript-likes]
----


******

=====
Then ::
=====
Dataset script should be interpreted while seeding the database icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

[[Database-assertion-using-expected-datasets, Database assertion using expected datasets]]
=== *Database assertion using expected datasets*

****
====
[quote]
____
In order to verify database state after test execution
As a developer
I want to assert database state with datasets.
____
====
****

==== Scenario: Database assertion with yml dataset

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.expectedUsers.yml
----
include::../../../core/src/test/resources/datasets/yml/expectedUsers.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,indent=0,linenums]
----
include::../../../core/src/test/java/com/github/dbunit/rules/ExpectedDataSetIt.java[tags=expectedDeclaration;expected]
----
[discrete]
<1> Clear database before to avoid conflict with other tests.


******

=====
Then ::
=====
Test must pass because database state is as in expected dataset. icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

==== Scenario: Database assertion with regular expression in expected dataset

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.expectedUsersRegex.yml
----
include::../../../core/src/test/resources/datasets/yml/expectedUsersRegex.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,indent=0,linenums]
----
include::../../../core/src/test/java/com/github/dbunit/rules/ExpectedDataSetIt.java[tags=expectedRegex]
----


******

=====
Then ::
=====
Test must pass because database state is as in expected dataset. icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

==== Scenario: Database assertion with seeding before test execution

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.user.yml
----
include::../../../core/src/test/resources/datasets/yml/user.yml[]
----


******

=====
And ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.expectedUser.yml
----
include::../../../core/src/test/resources/datasets/yml/expectedUser.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,indent=0,linenums]
----
include::../../../core/src/test/java/com/github/dbunit/rules/ExpectedDataSetIt.java[tags=expectedWithSeeding]
----


******

=====
Then ::
=====
Test must pass because database state is as in expected dataset. icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

==== Scenario: Failling database assertion

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.expectedUsers.yml
----
include::../../../core/src/test/resources/datasets/yml/expectedUsers.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,indent=0,linenums]
----
include::../../../core/src/test/java/com/github/dbunit/rules/ExpectedDataSetIt.java[tags=faillingExpected]
----


******

=====
Then ::
=====
Test must fail with following error: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
IMPORTANT: junit.framework.ComparisonFailure: value (table=USER, row=0, col=name) expected:<[]expected user1> but was:<[non ]expected user1>  at org.dbunit.assertion.JUnitFailureFactory.createFailure(JUnitFailureFactory.java:39) at org.dbunit.assertion.DefaultFailureHandler.createFailure(DefaultFailureHandler.java:97) at org.dbunit.assertion.DefaultFailureHandler.handle(DefaultFailureHandler.java:223) at ...


******

=====
****

==== Scenario: Database assertion using automatic transaction

****
Given ::
=====
The following dataset icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
.expectedUsersRegex.yml
----
include::../../../core/src/test/resources/datasets/yml/expectedUsersRegex.yml[]
----


******

=====
When ::
=====
The following test is executed: icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
******

[discrete]
[source,java,indent=0,linenums]
----
include::../../../core/src/test/java/com/github/dbunit/rules/TransactionIt.java[tags=transaction]
----


******

NOTE: `Transactional` attribute will make DBUnit Rules start a transaction before test and commit the transaction *after* test execution but *before* expected dataset comparison.

=====
Then ::
=====
Test must pass because inserted users are commited to database and database state matches expected dataset. icon:thumbs-up[role="green",title="Passed"] [small right]#(000ms)#
=====
****

